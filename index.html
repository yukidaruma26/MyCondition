<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyCondition</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            /* iOSã§ã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢å¯¾å¿œ */
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-in-down {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
        .animate-fade-in-down {
            animation: fade-in-down 0.3s ease-out forwards;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤ºãªã© */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans pb-10 min-h-screen">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-md mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i data-lucide="activity" class="text-blue-600"></i>
                <h1 class="text-xl font-bold text-gray-800">MyCondition</h1>
            </div>
            <button onclick="toggleSettings(true)" class="p-2 text-gray-500 hover:bg-blue-50 hover:text-blue-600 rounded-full transition-all relative group" aria-label="è¨­å®š">
                <i data-lucide="settings" width="22" height="22"></i>
                <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"></span>
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 py-6 space-y-6">
        
        <!-- é€šçŸ¥ -->
        <div id="notification" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-gray-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-lg z-50 transition-all hidden flex items-center w-max max-w-[90%] justify-center">
            <i data-lucide="check-circle" class="mr-2 text-green-400 flex-shrink-0" width="18" height="18"></i>
            <span id="notification-text" class="text-sm font-medium">è¨˜éŒ²ã—ã¾ã—ãŸï¼</span>
        </div>

        <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <!-- z-50ã¨safe-areaè€ƒæ…®ã®ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ -->
        <div id="settings-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm hidden animate-fade-in">
            <!-- max-h-[85vh]ã«å¤‰æ›´ã—ã¦ä¸Šä¸‹ã«ä½™è£•ã‚’æŒãŸã›ã‚‹ -->
            <div class="bg-white rounded-3xl w-full max-w-md p-6 shadow-2xl max-h-[85vh] overflow-y-auto relative flex flex-col">
                <div class="flex justify-between items-center mb-2 flex-shrink-0">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center">
                        <i data-lucide="settings" class="mr-2 text-blue-600" width="24" height="24"></i>
                        æ¨™æº–å€¤ã®è¨­å®š
                    </h3>
                    <button onclick="toggleSettings(false)" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                        <i data-lucide="x" class="text-gray-500" width="24" height="24"></i>
                    </button>
                </div>
                
                <div class="flex-grow overflow-y-auto no-scrollbar">
                    <div class="bg-blue-50 p-4 rounded-xl mb-6 flex items-start">
                        <i data-lucide="info" class="text-blue-600 mr-2 flex-shrink-0 mt-0.5" width="20" height="20"></i>
                        <p class="text-sm text-blue-800">
                            ã‚ãªãŸã®ã€Œã„ã¤ã‚‚ã®çŠ¶æ…‹ã€ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã‚’åŸºæº–ï¼ˆ50ç‚¹ç›¸å½“ï¼‰ã¨ã—ã¦ã€æ—¥ã€…ã®å¤‰åŒ–ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
                        </p>
                    </div>

                    <!-- è¨­å®šãƒ•ã‚©ãƒ¼ãƒ  -->
                    <div id="settings-form">
                        <!-- JSã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° -->
                    </div>
                </div>

                <div class="mt-6 flex space-x-3 flex-shrink-0 pt-2 bg-white sticky bottom-0">
                    <button onclick="toggleSettings(false)" class="flex-1 py-3 border-2 border-gray-200 rounded-xl font-bold text-gray-500 hover:bg-gray-50 transition-colors">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button onclick="saveBaselineSettings()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 hover:shadow-xl transition-all flex items-center justify-center transform active:scale-95">
                        <i data-lucide="check-circle" class="mr-2" width="18" height="18"></i>
                        ä¿å­˜
                    </button>
                </div>
            </div>
        </div>

        <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
        <div class="flex p-1 bg-gray-200 rounded-xl">
            <button onclick="switchTab('input')" id="tab-input" class="flex-1 py-2 text-sm font-bold rounded-lg transition-all bg-white shadow text-blue-600">
                å…¥åŠ›ãƒ»è¨ºæ–­
            </button>
            <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-2 text-sm font-bold rounded-lg transition-all text-gray-500 hover:text-gray-700">
                å±¥æ­´ãƒ»ã‚°ãƒ©ãƒ•
            </button>
        </div>

        <!-- å…¥åŠ›ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="content-input" class="space-y-6 animate-fade-in block">
            <!-- ãƒ¡ã‚¤ãƒ³ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚«ãƒ¼ãƒ‰ -->
            <div id="score-card" class="relative overflow-hidden rounded-3xl p-6 shadow-sm border transition-colors duration-500 text-gray-800 bg-gray-100">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i data-lucide="activity" width="120" height="120"></i>
                </div>
                
                <div class="relative z-10 text-center space-y-2">
                    <div class="flex justify-between items-center bg-white/40 rounded-xl p-2 mb-2 backdrop-blur-sm border border-white/50">
                        <span class="text-xs font-bold text-gray-600 uppercase tracking-wider pl-2">ã‚ãªãŸã®æ¨™æº–</span>
                        <div class="flex items-center text-sm font-bold text-gray-700">
                            <span id="display-baseline-score" class="text-xl mr-1">50</span>
                            <span class="text-xs text-gray-500 pt-1">/100</span>
                        </div>
                    </div>

                    <div class="py-2">
                        <div class="flex justify-center items-center space-x-2 mb-1">
                            <span class="text-sm font-bold text-gray-500">ç¾åœ¨</span>
                            <span id="display-current-score" class="text-6xl font-bold tracking-tighter">50</span>
                        </div>
                        
                        <!-- å·®åˆ†è¡¨ç¤ºãƒãƒƒã‚¸ -->
                        <div id="score-diff-badge" class="inline-flex items-center px-4 py-1.5 rounded-full font-bold shadow-sm backdrop-blur-md border border-white/60 bg-gray-100/80 text-gray-700">
                            <span id="diff-icon-container" class="mr-1.5 flex items-center"></span>
                            <span id="score-diff-text">ã„ã¤ã‚‚é€šã‚Š (Â±0)</span>
                        </div>
                    </div>
                    
                    <div id="display-face" class="text-6xl py-2 filter drop-shadow-sm transition-transform hover:scale-110 cursor-default">
                        ğŸ™‚
                    </div>
                    
                    <!-- ã‚²ãƒ¼ã‚¸å¯è¦–åŒ– -->
                    <div class="relative pt-6 pb-2">
                        <!-- ãƒãƒ¼èƒŒæ™¯ -->
                        <div class="h-3 w-full bg-gray-200/50 rounded-full overflow-hidden relative">
                            <!-- ç¾åœ¨å€¤ãƒãƒ¼ -->
                            <div id="score-bar" class="absolute top-0 left-0 h-full transition-all duration-500 ease-out bg-blue-500" style="width: 50%"></div>
                        </div>
                        
                        <!-- æ¨™æº–å€¤ãƒãƒ¼ã‚«ãƒ¼ -->
                        <div id="baseline-marker" class="absolute top-4 w-1 h-7 bg-gray-800 z-20 rounded-full shadow transition-all duration-500" style="left: 50%; transform: translateX(-50%)">
                            <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-[10px] font-bold text-gray-600 bg-white px-1.5 py-0.5 rounded border shadow-sm whitespace-nowrap">
                                æ¨™æº–
                            </div>
                        </div>
                        
                        <div class="flex justify-between text-[10px] font-bold text-gray-400 mt-2 px-1">
                            <span>0</span>
                            <span>50</span>
                            <span>100</span>
                        </div>
                    </div>

                    <p id="advice-text" class="text-sm font-medium pt-3 mt-2 border-t border-black/10">
                        ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’è¡¨ç¤º...
                    </p>
                </div>
            </div>

            <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold flex items-center text-gray-800">
                        <i data-lucide="info" class="mr-2 text-blue-500" width="20" height="20"></i>
                        ä»Šã®çŠ¶æ…‹
                    </h2>
                    <button onclick="toggleSettings(true)" class="text-xs font-medium text-blue-600 hover:text-blue-800 bg-blue-50 px-3 py-1.5 rounded-full transition-colors flex items-center">
                        <i data-lucide="settings" class="mr-1" width="12" height="12"></i>
                        æ¨™æº–å€¤: <span id="form-baseline-score">50</span>
                    </button>
                </div>
                
                <div id="main-input-form">
                    <!-- JSã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° -->
                </div>

                <button onclick="saveCurrentState()" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition-all active:scale-95 flex items-center justify-center space-x-2">
                    <i data-lucide="save" width="20" height="20"></i>
                    <span>ä»Šã®çŠ¶æ…‹ã‚’è¨˜éŒ²ã™ã‚‹</span>
                </button>
            </div>
        </div>

        <!-- å±¥æ­´ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="content-history" class="space-y-6 animate-fade-in hidden">
            <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 overflow-hidden">
                <h2 class="text-lg font-bold mb-4 flex items-center text-gray-800">
                    <i data-lucide="trending-up" class="mr-2 text-blue-500" width="20" height="20"></i>
                    èª¿å­ã®æ¨ç§» (æœ€æ–°10ä»¶)
                </h2>
                
                <div id="graph-container" class="relative h-40 w-full mt-4">
                    <!-- èƒŒæ™¯ã®ã‚°ãƒªãƒƒãƒ‰ç·š -->
                    <div class="absolute inset-0 flex flex-col justify-between text-xs text-gray-300">
                        <div class="border-b border-gray-100 w-full">100</div>
                        <!-- æ¨™æº–ãƒ©ã‚¤ãƒ³ -->
                        <div id="graph-baseline-line" class="border-b-2 border-dashed border-gray-400 w-full absolute z-0 transition-all duration-300" style="bottom: 50%; opacity: 0.5;"></div>
                        <div class="border-b border-gray-100 w-full">0</div>
                    </div>
                    
                    <!-- SVGã‚°ãƒ©ãƒ• -->
                    <svg id="history-chart" class="absolute inset-0 w-full h-full overflow-visible z-10" preserveAspectRatio="none">
                        <!-- JSã§æç”» -->
                    </svg>
                    <p id="graph-baseline-label" class="text-[10px] text-gray-500 bg-white px-1 absolute right-0 -bottom-4 z-20">ç‚¹ç·š: ç¾åœ¨ã®æ¨™æº– (50)</p>
                    
                    <div id="no-data-msg" class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm bg-gray-50 rounded-lg border border-dashed border-gray-200 hidden">
                        ãƒ‡ãƒ¼ã‚¿ãŒ2ä»¶ä»¥ä¸Šã‚ã‚‹ã¨ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                    </div>
                </div>
            </div>

            <!-- å±¥æ­´ãƒªã‚¹ãƒˆ -->
            <div class="space-y-3">
                <h2 class="text-lg font-bold flex items-center text-gray-800 px-1">
                    <i data-lucide="history" class="mr-2 text-gray-500" width="20" height="20"></i>
                    éå»ã®è¨˜éŒ²
                </h2>
                
                <div id="history-list" class="space-y-3">
                    <!-- JSã§ãƒªã‚¹ãƒˆç”Ÿæˆ -->
                </div>
                <p id="history-empty-msg" class="text-center text-gray-400 py-8 hidden">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            </div>
        </div>

    </main>

    <script>
        // --- è¨­å®šãƒ»çŠ¶æ…‹ ---
        let state = {
            mood: 3,
            energy: 3,
            stress: 3,
            sleep: 3
        };
        
        let baseline = {
            mood: 3,
            energy: 3,
            stress: 3,
            sleep: 3
        };

        let historyData = [];

        // --- å®šæ•°ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        const ITEMS = [
            { key: 'mood', label: 'æ°—åˆ†', icon: 'smile', colorClass: 'text-orange-500', baseColor: 'bg-orange-500' },
            { key: 'energy', label: 'ä½“ã®å…ƒæ°—', icon: 'zap', colorClass: 'text-yellow-500', baseColor: 'bg-yellow-500' },
            { key: 'sleep', label: 'ç¡çœ ã®è³ª', icon: 'moon', colorClass: 'text-purple-500', baseColor: 'bg-purple-500' },
            { key: 'stress', label: 'ã‚¹ãƒˆãƒ¬ã‚¹åº¦', icon: 'heart', colorClass: 'text-red-500', baseColor: 'bg-red-500' }
        ];

        // --- ãƒ­ã‚¸ãƒƒã‚¯ ---

        function getScoreColor(score) {
            if (score >= 80) return 'text-green-500 bg-green-50 border-green-200';
            if (score >= 60) return 'text-teal-500 bg-teal-50 border-teal-200';
            if (score >= 40) return 'text-yellow-500 bg-yellow-50 border-yellow-200';
            if (score >= 20) return 'text-orange-500 bg-orange-50 border-orange-200';
            return 'text-red-500 bg-red-50 border-red-200';
        }

        function getProgressBarColor(score) {
            if (score >= 80) return 'bg-green-500';
            if (score >= 60) return 'bg-teal-500';
            if (score >= 40) return 'bg-yellow-500';
            if (score >= 20) return 'bg-orange-500';
            return 'bg-red-500';
        }

        function getAdvice(score, diff, stress) {
            if (diff >= 15) return "çµ¶å¥½èª¿ã§ã™ã­ï¼ã„ã¤ã‚‚ã‚ˆã‚Šã‚¨ãƒãƒ«ã‚®ãƒ¼ã«æº€ã¡ã¦ã„ã¾ã™ã€‚";
            if (diff >= 5) return "ã„ã¤ã‚‚ã‚ˆã‚Šå°‘ã—èª¿å­ãŒè‰¯ã„ã‚ˆã†ã§ã™ã€‚è‰¯ã„ä¸€æ—¥ã«ãªã‚Šãã†ã€‚";
            if (Math.abs(diff) < 5) return "ã„ã¤ã‚‚é€šã‚Šã®å®‰å®šã—ãŸçŠ¶æ…‹ã§ã™ã€‚ãƒã‚¤ãƒšãƒ¼ã‚¹ã§ã„ãã¾ã—ã‚‡ã†ã€‚";
            if (diff <= -15) return "ã„ã¤ã‚‚ã‚ˆã‚Šã‹ãªã‚ŠãŠç–²ã‚Œã®ã‚ˆã†ã§ã™ã€‚ç„¡ç†ã›ãšä¼‘æ¯ã‚’æœ€å„ªå…ˆã«ã€‚";
            if (diff <= -5) return "ã„ã¤ã‚‚ã‚ˆã‚Šå°‘ã—å…ƒæ°—ãŒè¶³ã‚Šãªã„ã‹ã‚‚ã€‚æ—©ã‚ã®ç¡çœ ã‚’å¿ƒãŒã‘ã¦ã€‚";
            return "ç„¡ç†ã›ãšã€è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§éã”ã—ã¾ã—ã‚‡ã†ã€‚";
        }

        function getFace(score) {
            if (score >= 80) return "ğŸ˜†";
            if (score >= 60) return "ğŸ™‚";
            if (score >= 40) return "ğŸ˜";
            if (score >= 20) return "ğŸ˜°";
            return "ğŸ˜µ";
        }

        function calculateScore(mood, energy, sleep, stress) {
            let calc = ((mood + energy + sleep - stress + 2) / 16) * 100;
            return Math.round(Math.max(0, Math.min(100, calc)));
        }

        // --- UIæ§‹ç¯‰ç”¨é–¢æ•° ---

        function createLevelSelectorHTML(item, value, onChangeName, isSettings = false) {
            const prefix = isSettings ? 'setting' : 'input';
            let buttonsHtml = '';
            for (let i = 1; i <= 5; i++) {
                const isSelected = value === i;
                const activeClass = isSelected 
                    ? `${item.baseColor} text-white shadow-md scale-105` 
                    : 'bg-gray-100 text-gray-400 hover:bg-gray-200';
                
                buttonsHtml += `
                    <button onclick="${onChangeName}('${item.key}', ${i})"
                        class="flex-1 h-12 rounded-xl font-bold text-lg transition-all duration-200 transform active:scale-95 ${activeClass}">
                        ${i}
                    </button>
                `;
            }

            return `
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <label class="flex items-center font-bold text-gray-700">
                            <i data-lucide="${item.icon}" class="mr-2 ${item.colorClass}" width="20" height="20"></i>
                            ${isSettings ? 'ã„ã¤ã‚‚ã®' : ''}${item.label}
                        </label>
                        <span class="text-sm font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded">
                            ${value}
                        </span>
                    </div>
                    <div class="flex justify-between gap-2">
                        ${buttonsHtml}
                    </div>
                    <div class="flex justify-between text-xs text-gray-400 mt-1 px-1">
                        <span>ä½ã„/æ‚ªã„</span>
                        <span>é«˜ã„/è‰¯ã„</span>
                    </div>
                </div>
            `;
        }

        // --- æ“ä½œãƒ»æ›´æ–°å‡¦ç† ---

        function updateState(key, value) {
            state[key] = value;
            renderApp();
        }

        let tempBaseline = { ...baseline };
        function updateTempBaseline(key, value) {
            tempBaseline[key] = value;
            renderSettingsForm();
        }

        function toggleSettings(show) {
            const modal = document.getElementById('settings-modal');
            if (show) {
                tempBaseline = { ...baseline }; // Reset temp
                renderSettingsForm();
                modal.classList.remove('hidden');
                modal.classList.add('animate-fade-in');
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('animate-fade-in');
            }
        }

        function saveBaselineSettings() {
            baseline = { ...tempBaseline };
            localStorage.setItem('my_condition_settings', JSON.stringify(baseline));
            toggleSettings(false);
            showNotification('æ¨™æº–å€¤ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            renderApp();
        }

        function saveCurrentState() {
            const currentScore = calculateScore(state.mood, state.energy, state.sleep, state.stress);
            const baselineScore = calculateScore(baseline.mood, baseline.energy, baseline.sleep, baseline.stress);
            const scoreDiff = currentScore - baselineScore;

            const newEntry = {
                id: Date.now(),
                date: new Date().toISOString(),
                score: currentScore,
                details: { ...state },
                baselineDiff: scoreDiff,
                baselineScore: baselineScore
            };

            historyData = [newEntry, ...historyData];
            localStorage.setItem('my_condition_data', JSON.stringify(historyData));
            showNotification('è¨˜éŒ²ã—ã¾ã—ãŸï¼');
            renderApp();
        }

        function deleteHistory(id) {
            historyData = historyData.filter(item => item.id !== id);
            localStorage.setItem('my_condition_data', JSON.stringify(historyData));
            renderHistoryList();
            renderGraph();
        }

        function switchTab(tabName) {
            const inputBtn = document.getElementById('tab-input');
            const historyBtn = document.getElementById('tab-history');
            const inputContent = document.getElementById('content-input');
            const historyContent = document.getElementById('content-history');

            if (tabName === 'input') {
                inputBtn.className = 'flex-1 py-2 text-sm font-bold rounded-lg transition-all bg-white shadow text-blue-600';
                historyBtn.className = 'flex-1 py-2 text-sm font-bold rounded-lg transition-all text-gray-500 hover:text-gray-700';
                inputContent.classList.remove('hidden');
                historyContent.classList.add('hidden');
            } else {
                historyBtn.className = 'flex-1 py-2 text-sm font-bold rounded-lg transition-all bg-white shadow text-blue-600';
                inputBtn.className = 'flex-1 py-2 text-sm font-bold rounded-lg transition-all text-gray-500 hover:text-gray-700';
                historyContent.classList.remove('hidden');
                inputContent.classList.add('hidden');
                renderGraph();
            }
        }

        function showNotification(msg) {
            const notif = document.getElementById('notification');
            const text = document.getElementById('notification-text');
            text.textContent = msg;
            notif.classList.remove('hidden');
            notif.classList.add('animate-fade-in-down');
            
            setTimeout(() => {
                notif.classList.add('hidden');
                notif.classList.remove('animate-fade-in-down');
            }, 3000);
        }

        function formatDate(isoString) {
            const d = new Date(isoString);
            return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
        }

        // --- æç”»é–¢æ•°ç¾¤ ---

        function renderSettingsForm() {
            const container = document.getElementById('settings-form');
            container.innerHTML = ITEMS.map(item => 
                createLevelSelectorHTML(item, tempBaseline[item.key], 'updateTempBaseline', true)
            ).join('');
            lucide.createIcons();
        }

        function renderHistoryList() {
            const listContainer = document.getElementById('history-list');
            const emptyMsg = document.getElementById('history-empty-msg');

            if (historyData.length === 0) {
                listContainer.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                return;
            }
            emptyMsg.classList.add('hidden');

            listContainer.innerHTML = historyData.map(item => {
                const colorClass = getProgressBarColor(item.score);
                let diffBadge = '';
                if (item.baselineDiff !== undefined) {
                    const diffClass = item.baselineDiff > 0 ? 'bg-green-100 text-green-700' : 
                                    item.baselineDiff < 0 ? 'bg-red-100 text-red-700' : 
                                    'bg-gray-100 text-gray-600';
                    const sign = item.baselineDiff > 0 ? '+' : '';
                    diffBadge = `<span class="text-xs px-1.5 py-0.5 rounded font-bold ${diffClass}">${sign}${item.baselineDiff}</span>`;
                }

                return `
                <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center transition-transform hover:translate-x-1">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold text-white ${colorClass}">
                            ${item.score}
                        </div>
                        <div>
                            <div class="flex items-center space-x-2">
                                <p class="text-sm font-semibold text-gray-700">${formatDate(item.date)}</p>
                                ${diffBadge}
                            </div>
                            <div class="flex space-x-3 mt-1 text-xs text-gray-500">
                                <span class="flex items-center"><i data-lucide="smile" width="10" class="mr-1"></i>${item.details.mood}</span>
                                <span class="flex items-center"><i data-lucide="zap" width="10" class="mr-1"></i>${item.details.energy}</span>
                                <span class="flex items-center"><i data-lucide="moon" width="10" class="mr-1"></i>${item.details.sleep}</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="deleteHistory(${item.id})" class="p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors">
                        <i data-lucide="trash-2" width="16" height="16"></i>
                    </button>
                </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderGraph() {
            const svg = document.getElementById('history-chart');
            const noDataMsg = document.getElementById('no-data-msg');
            const baselineLine = document.getElementById('graph-baseline-line');
            const baselineLabel = document.getElementById('graph-baseline-label');

            // Baseline Line Update
            const baselineScore = calculateScore(baseline.mood, baseline.energy, baseline.sleep, baseline.stress);
            baselineLine.style.bottom = `${baselineScore}%`;
            baselineLabel.textContent = `ç‚¹ç·š: ç¾åœ¨ã®æ¨™æº– (${baselineScore})`;

            if (historyData.length < 2) {
                svg.innerHTML = '';
                noDataMsg.classList.remove('hidden');
                return;
            }
            noDataMsg.classList.add('hidden');

            // ä¿®æ­£: SVGã®viewBoxã¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°è¨ˆç®—
            // width, heightã¯å†…éƒ¨åº§æ¨™ç³»ã¨ã—ã¦å›ºå®šå€¤ã‚’ä½¿ç”¨ã™ã‚‹ãŒã€
            // HTMLå´ã®SVGã‚¿ã‚°ã«preserveAspectRatio="none"ã‚’ã¤ã‘ã‚‹ã“ã¨ã§
            // ã‚³ãƒ³ãƒ†ãƒŠã«åˆã‚ã›ã¦ä¼¸ç¸®ã•ã›ã‚‹
            const width = 350;
            const height = 160;
            const paddingX = 10; // å·¦å³ã®ä½™ç™½
            const paddingY = 10; // ä¸Šä¸‹ã®ä½™ç™½

            // SVGã®è¨­å®šã‚’æ›´æ–°
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            // æ³¨æ„: preserveAspectRatio="none" ã¯æ¨ªå¹…ã®å¤‰åŒ–ã«å¯¾ã—ã¦ã‚°ãƒ©ãƒ•ã‚’ä¼¸ç¸®ã•ã›ã‚‹
            // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ãŸã„å ´åˆã¯ "xMidYMid meet" ãªã©ã«ã™ã‚‹ãŒ
            // ä»Šå›ã¯é ˜åŸŸå…¨ä½“ã‚’ä½¿ã†ãŸã‚ã«noneãŒé©ã—ã¦ã„ã‚‹

            // ãƒ‡ãƒ¼ã‚¿æº–å‚™
            const chartData = [...historyData].slice(0, 10).reverse();
            
            // æç”»ã‚¨ãƒªã‚¢ã®è¨ˆç®—
            const drawWidth = width - (paddingX * 2);
            const drawHeight = height - (paddingY * 2);
            
            const stepX = drawWidth / (chartData.length - 1);

            // Pathç”Ÿæˆ
            const points = chartData.map((item, index) => {
                const x = paddingX + (index * stepX);
                const y = paddingY + (drawHeight - (item.score / 100) * drawHeight);
                return `${x},${y}`;
            });
            const d = `M ${points.join(" L ")}`;

            // Pointsç”Ÿæˆ
            const circles = chartData.map((item, index) => {
                const x = paddingX + (index * stepX);
                const y = paddingY + (drawHeight - (item.score / 100) * drawHeight);
                return `<circle cx="${x}" cy="${y}" r="4" fill="white" stroke="#3B82F6" stroke-width="2"></circle>`;
            }).join('');

            svg.innerHTML = `
                <path d="${d}" fill="none" stroke="#3B82F6" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="drop-shadow-sm"></path>
                ${circles}
            `;
        }

        function renderApp() {
            // è¨ˆç®—
            const currentScore = calculateScore(state.mood, state.energy, state.sleep, state.stress);
            const baselineScore = calculateScore(baseline.mood, baseline.energy, baseline.sleep, baseline.stress);
            const scoreDiff = currentScore - baselineScore;

            // DOMè¦ç´ å–å¾—
            const scoreCard = document.getElementById('score-card');
            const displayCurrent = document.getElementById('display-current-score');
            const displayBaseline = document.getElementById('display-baseline-score');
            const displayFace = document.getElementById('display-face');
            const scoreBar = document.getElementById('score-bar');
            const baselineMarker = document.getElementById('baseline-marker');
            const adviceText = document.getElementById('advice-text');
            const scoreDiffBadge = document.getElementById('score-diff-badge');
            const scoreDiffText = document.getElementById('score-diff-text');
            const diffIconContainer = document.getElementById('diff-icon-container');
            const formBaselineScore = document.getElementById('form-baseline-score');
            const mainInputForm = document.getElementById('main-input-form');

            // è‰²ã‚¯ãƒ©ã‚¹æ›´æ–°
            const themeClass = getScoreColor(currentScore);
            scoreCard.className = `relative overflow-hidden rounded-3xl p-6 shadow-sm border transition-colors duration-500 ${themeClass}`;

            // å€¤ã®åæ˜ 
            displayCurrent.textContent = currentScore;
            displayBaseline.textContent = baselineScore;
            formBaselineScore.textContent = baselineScore;
            displayFace.textContent = getFace(currentScore);
            scoreBar.style.width = `${currentScore}%`;
            scoreBar.className = `absolute top-0 left-0 h-full transition-all duration-500 ease-out ${getProgressBarColor(currentScore)}`;
            baselineMarker.style.left = `${baselineScore}%`;
            adviceText.textContent = getAdvice(currentScore, scoreDiff, state.stress);

            // ãƒãƒƒã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¨ãƒ†ã‚­ã‚¹ãƒˆ
            let badgeClass = 'bg-gray-100/80 text-gray-700';
            let diffText = 'ã„ã¤ã‚‚é€šã‚Š (Â±0)';
            let iconName = 'check-circle';

            if (scoreDiff > 0) {
                badgeClass = 'bg-green-100/80 text-green-800';
                diffText = `ã„ã¤ã‚‚ã‚ˆã‚Šè‰¯ã„ (+${scoreDiff})`;
                iconName = 'trending-up';
            } else if (scoreDiff < 0) {
                badgeClass = 'bg-red-100/80 text-red-800';
                diffText = `ã„ã¤ã‚‚ã‚ˆã‚Šæ‚ªã„ (${scoreDiff})`;
                iconName = 'alert-circle';
            }
            scoreDiffBadge.className = `inline-flex items-center px-4 py-1.5 rounded-full font-bold shadow-sm backdrop-blur-md border border-white/60 ${badgeClass}`;
            scoreDiffText.textContent = diffText;
            
            // ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
            diffIconContainer.innerHTML = `<i data-lucide="${iconName}" width="16" height="16"></i>`;

            // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ å†æç”»
            mainInputForm.innerHTML = ITEMS.map(item => 
                createLevelSelectorHTML(item, state[item.key], 'updateState')
            ).join('');

            // å±¥æ­´ãƒªã‚¹ãƒˆæ›´æ–°
            renderHistoryList();

            // ã‚¢ã‚¤ã‚³ãƒ³å†ã‚¹ã‚­ãƒ£ãƒ³
            lucide.createIcons();
        }

        // --- åˆæœŸåŒ– ---
        window.onload = function() {
            // ãƒ­ãƒ¼ãƒ‰
            const savedData = localStorage.getItem('my_condition_data');
            if (savedData) {
                historyData = JSON.parse(savedData);
            }
            
            const savedSettings = localStorage.getItem('my_condition_settings');
            if (savedSettings) {
                baseline = JSON.parse(savedSettings);
                state = { ...baseline };
            }

            // åˆå›æç”»
            renderApp();
            renderGraph();
        };

    </script>
</body>
</html>
